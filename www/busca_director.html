<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
 <title>Documento sin t√≠tulo</title>
    <link href="css/estilos.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="css/fontello.css" type="text/css">
	<script type="text/javascript" src="cordova.js"></script>
    <script src="js/jquery-3.1.1.js"></script>
</head>

<body>
<a href="index.html" class="boton2 ancho-back"><span class="icon-left-open"></span></a><button class="boton2" style="width: 90vw" disabled>BUSCANDO DIRECTORES</button>
<div class="titulo_cancion" style="z-index:99">
	<font color="white">Buscando Directores en la red</font>
</div>
    <div id="list" class="listado">
    <ul id="Listado_directores" class="listado_directores"></ul>
</div>
<input type="hidden" id="contador" value="0">
<!--<input type="hidden" id="memoporce" value="0">-->
<button id="buscar" class="buscar2" style="display:none" onClick="lectura_ip()">Volver a Buscar Servidor</button>
<progress id="memoporce" class="buscar" max="102.4" value="0"></progress>
</body>
	<script>
		
	document.addEventListener("deviceready", lectura_ip, false);
	function lectura_ip()
		{
		document.getElementById('memoporce').value=0;
		document.getElementById('contador').valuo=0;
		document.getElementById('buscar').style.display='none';
		/*var direccion="192.168.1.39";
		busca_director(direccion)*/
			
		function onSuccess( ipInformation ) 
			{
			ipInformation.ip
			//ipInformation.subnet
			var direccion=ipInformation.ip;
			//var direccion="192.168.1.39";
			busca_director(direccion)
			}
		function onError( error ) 
			{
			var direccion="192.168.1.1";
			busca_director(direccion)
			// Note: onError() will be called when an IP address can't be found. eg WiFi is disabled, no SIM card, Airplane mode etc.
			//alert( error );
			}
		networkinterface.getWiFiIPAddress( onSuccess, onError );
		networkinterface.getCarrierIPAddress( onSuccess, onError );
		}
	function busca_director(direccion)
		{
			console.log("valor:"+direccion+"---")
			var dir=direccion.split(".");
	 		var ip=1;
			$('#Listado_directores').empty();
			while(ip<=255)
				{
				var address=dir[0]+"."+dir[1]+"."+dir[2]+"."+ip;
				var ws = new WebSocket('ws://'+address+':45000');
				ws.onopen = function () {
					console.log('open');
					this.send('001');// transmit "hello" after connecting 
				};
			 	
				ws.onmessage = function (event) {
					var obj = JSON.parse(event.data);
					console.log(obj.direccion);    // will be "hello"
					calculo();
					$('#Listado_directores').append('<li style="height:50px; line-height:40px"><a href="cancion_detalle_musico.html?v1='+obj.direccion+'&v2='+obj.nombre_usuario+'"><p><span class="icon-headphones"> - <font style="font-size:16px; font-weight:bold">'+obj.nombre_usuario+'</font></span></p></a></li>');
					this.close();
				};
			 
				ws.onerror = function () {
					console.log('error occurred!');
				};
			 
				ws.onclose = function (event) {
					console.log('close code=' + event.code);
					calculo();
				};
				ip++;
				}
				
		}
		
		function calculo(){
			var con = document.getElementById('memoporce').value;
			var porce=parseFloat(con)+parseFloat(0.39);
			porce=Math.round(porce*10)/10;
			if(porce>100){
				document.getElementById('buscar').style.display='';
			}
			document.getElementById('memoporce').value=porce;
			var memo=document.getElementById('memoporce').value;
			if(memo>100){memo=100;}
			memo=Math.round(memo);
			document.getElementById('contador').value=memo;
			
		}
		
	</script>

</html>